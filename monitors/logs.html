<div x-data="logsMonitor()" class="h-full flex flex-col" x-clock>
  <!-- Connection status indicator and controls -->
  <div class="px-4 py-2 bg-white dark:bg-gray-950 border-b dark:border-gray-700 border-gray-200 sticky top-0 left-0">
    <div class="space-y-2">
      <div class="flex items-center justify-start space-x-4">
        <!-- Search input -->
        <div class="flex items-center space-x-2">
          <input
            type="text"
            x-model="searchQuery"
            @input="applyFilter()"
            placeholder="Search..."
            class="px-3 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <button
          @click="toggleLiveUpdates()"
          class="px-3 py-1 text-xs rounded transition-colors"
          :class="liveUpdatesEnabled ? 'bg-blue-500 hover:bg-blue-600 text-white' : 'bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200'"
        >
          <span x-text="liveUpdatesEnabled ? 'Live Updates ON' : 'Live Updates OFF'"></span>
        </button>
        <div class="flex items-center space-x-2">
          <div :class="connected ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></div>
          <span class="text-xs text-gray-500 dark:text-gray-400" x-text="connected ? 'Connected' : 'Disconnected'"></span>
        </div>
      </div>
      <!-- Log level filters -->
      <div class="flex items-center space-x-2">
        <span class="text-xs text-gray-500 dark:text-gray-400">Levels:</span>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="checkbox" x-model="logLevels.DEBUG" @change="applyFilter()" class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="text-xs text-gray-700 dark:text-gray-300">DEBUG</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="checkbox" x-model="logLevels.INFO" @change="applyFilter()" class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="text-xs text-gray-700 dark:text-gray-300">INFO</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="checkbox" x-model="logLevels.WARN" @change="applyFilter()" class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="text-xs text-gray-700 dark:text-gray-300">WARN</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="checkbox" x-model="logLevels.ERROR" @change="applyFilter()" class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="text-xs text-gray-700 dark:text-gray-300">ERROR</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="checkbox" x-model="logLevels.FATAL" @change="applyFilter()" class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="text-xs text-gray-700 dark:text-gray-300">FATAL</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="checkbox" x-model="logLevels.PANIC" @change="applyFilter()" class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="text-xs text-gray-700 dark:text-gray-300">PANIC</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="checkbox" x-model="logLevels.PRINT" @change="applyFilter()" class="w-3 h-3 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
          <span class="text-xs text-gray-700 dark:text-gray-300">PRINT</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Content area -->
  <div class="flex-1 overflow-y-auto p-4">
    <div class="space-y-2">
      <!-- Display entries in reverse order (newest first) -->
      <template x-for="entry in filteredEntries" :key="entry.id">
        <div
          class="bg-gray-50 dark:bg-gray-800 rounded p-4 border border-gray-200 dark:border-gray-700"
          :class="{ 'entry-appear': entry.isNew }"
        >
          <div class="flex items-start justify-between mb-2">
            <div class="flex items-center space-x-3">
              <!-- Log level badge -->
              <span
                class="px-2 py-1 text-xs font-mono font-semibold rounded"
                :class="{
                  'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200': entry.payload.level === 'DEBUG',
                  'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': entry.payload.level === 'INFO',
                  'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200': entry.payload.level === 'WARN',
                  'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': entry.payload.level === 'ERROR',
                  'bg-red-600 text-white dark:bg-red-700': entry.payload.level === 'FATAL',
                  'bg-purple-600 text-white dark:bg-purple-700': entry.payload.level === 'PANIC',
                  'bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-100': entry.payload.level === 'PRINT'
                }"
                x-text="entry.payload.level"
              ></span>
            </div>

            <!-- Timestamp -->
            <span class="text-xs text-gray-500 dark:text-gray-400 font-mono" x-text="formatTimestamp(entry.payload.timestamp)"></span>
          </div>

          <!-- Log message -->
          <div>
            <pre class="text-xs text-gray-900 dark:text-gray-100 font-mono whitespace-pre-wrap break-words" x-text="entry.payload.message"></pre>
          </div>
        </div>
      </template>

      <!-- Empty state -->
      <template x-if="isBooted && entries.length === 0">
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">No logs yet</p>
        </div>
      </template>

      <!-- No matching results -->
      <template x-if="isBooted && entries.length > 0 && filteredEntries.length === 0">
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">No matching results</p>
        </div>
      </template>
    </div>
  </div>
</div>

<script>
  function logsMonitor() {
    return {
      entries: [],
      lastId: 0,
      connected: false,
      liveUpdatesEnabled: true,
      eventSource: null,
      isBooted: false,
      searchQuery: '',
      logLevels: {
        DEBUG: true,
        INFO: true,
        WARN: true,
        ERROR: true,
        FATAL: true,
        PANIC: true,
        PRINT: true
      },

      init: function () {
        this.connectSSE();
      },

      get filteredEntries() {
        let filtered = this.entries;

        // Filter by log level
        filtered = filtered.filter(entry => {
          const level = entry.payload?.level || '';
          return this.logLevels[level] === true;
        });

        // Filter by search query
        if (this.searchQuery.trim()) {
          const query = this.searchQuery.toLowerCase();
          filtered = filtered.filter(entry => {
            const message = entry.payload?.message || '';
            return message.toLowerCase().includes(query);
          });
        }

        return filtered;
      },

      applyFilter() {
        // Filter is applied reactively through the filteredEntries getter
      },

      toggleLiveUpdates() {
        this.liveUpdatesEnabled = !this.liveUpdatesEnabled;

        if (this.liveUpdatesEnabled) {
          // Turn live updates ON
          this.connectSSE();
        } else {
          // Turn live updates OFF
          this.disconnectSSE();
        }
      },

      connectSSE() {
        // Don't connect if live updates are disabled
        if (!this.liveUpdatesEnabled) {
          return;
        }

        const params = new URLSearchParams(window.location.search);
        const monitor = params.get('monitor');

        // Close existing connection if any
        if (this.eventSource) {
          this.eventSource.close();
        }

        this.eventSource = new EventSource(`?monitor=${monitor}&action=stream&since=${this.lastId}`);

        this.eventSource.onopen = () => {
          this.connected = true;
          // Mark as booted once connection is established
          this.isBooted = true;
        };

        this.eventSource.onerror = (error) => {
          console.error('SSE connection error:', error);
          this.connected = false;

          // Only attempt to reconnect if live updates are still enabled
          if (this.liveUpdatesEnabled) {
            setTimeout(() => {
              this.connectSSE();
            }, 5000);
          }
        };

        this.eventSource.onmessage = (event) => {
          try {
            const entry = JSON.parse(event.data);
            // Mark as new for animation
            entry.isNew = true;
            this.entries.unshift(entry);
            // Update last ID
            this.lastId = entry.id;
            // Remove isNew flag after animation completes
            setTimeout(() => {
              entry.isNew = false;
            }, 350);
          } catch (error) {
            console.error('Failed to parse SSE message:', error);
          }
        };
      },

      disconnectSSE() {
        if (this.eventSource) {
          this.eventSource.close();
          this.eventSource = null;
          this.connected = false;
        }
      },

      formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        const ms = String(date.getMilliseconds()).padStart(3, '0');
        return `${hours}:${minutes}:${seconds}.${ms}`;
      },

      destroy() {
        // Cleanup when component is destroyed
        this.disconnectSSE();
      }
    }
  }
</script>
